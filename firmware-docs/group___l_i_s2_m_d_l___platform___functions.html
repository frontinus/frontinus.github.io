<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Da Vinci Firmware: STM32H7xx SPI Platform Specific Functions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="PRT-logo-horizontal-dark-resized.png"/></td>
  <td id="projectalign">
   <div id="projectname">Da Vinci Firmware<span id="projectnumber">&#160;1</span>
   </div>
   <div id="projectbrief">Firmware for the DaVinci-M rocket avionics board.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('group___l_i_s2_m_d_l___platform___functions.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">STM32H7xx SPI Platform Specific Functions<div class="ingroups"><a class="el" href="group___peripherals.html">Peripheral Drivers</a> &raquo; <a class="el" href="group___l_i_s2_m_d_l.html">&quot;LIS2MDL Magnetometer Driver&quot;</a> &raquo; <a class="el" href="group___l_i_s2_m_d_l__serial__interface.html">&quot;Serial Interface&quot;</a></div></div></div>
</div><!--header-->
<div class="contents">

<p>Functions to connect LIS2MDL driver to STM32H7xx SPI HAL.  
<a href="#details">More...</a></p>
<div class="dynheader">
Collaboration diagram for STM32H7xx SPI Platform Specific Functions:</div>
<div class="dyncontent">
<div class="center"><img src="group___l_i_s2_m_d_l___platform___functions.png" border="0" usemap="#agroup______l__i__s2__m__d__l______platform______functions" alt=""/></div>
<map name="agroup______l__i__s2__m__d__l______platform______functions" id="agroup______l__i__s2__m__d__l______platform______functions">
<area shape="rect" title="Functions to connect LIS2MDL driver to STM32H7xx SPI HAL." alt="" coords="173,5,346,48"/>
<area shape="rect" href="group___l_i_s2_m_d_l__serial__interface.html" title="This section group all the functions concerning serial interface management." alt="" coords="5,13,125,40"/>
</map>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga67b21fa9e2ec45ca3bdae198980f874f"><td class="memItemLeft" align="right" valign="top">static int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___l_i_s2_m_d_l___platform___functions.html#ga67b21fa9e2ec45ca3bdae198980f874f">platform_spi_write</a> (void *handle, uint8_t reg, const uint8_t *bufp, uint16_t len)</td></tr>
<tr class="memdesc:ga67b21fa9e2ec45ca3bdae198980f874f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Write data to LIS2MDL sensor via SPI.  <br /></td></tr>
<tr class="separator:ga67b21fa9e2ec45ca3bdae198980f874f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa2c2949e73d04353b41eb92896a7f360"><td class="memItemLeft" align="right" valign="top">static int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___l_i_s2_m_d_l___platform___functions.html#gaa2c2949e73d04353b41eb92896a7f360">platform_spi_read</a> (void *handle, uint8_t reg, uint8_t *bufp, uint16_t len)</td></tr>
<tr class="memdesc:gaa2c2949e73d04353b41eb92896a7f360"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read data from LIS2MDL sensor via SPI.  <br /></td></tr>
<tr class="separator:gaa2c2949e73d04353b41eb92896a7f360"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa8ce944f7edb970a79e3c04f3eac796e"><td class="memItemLeft" align="right" valign="top">int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___l_i_s2_m_d_l___platform___functions.html#gaa8ce944f7edb970a79e3c04f3eac796e">lis2mdl_init</a> (<a class="el" href="structstmdev__ctx__t.html">stmdev_ctx_t</a> *ctx)</td></tr>
<tr class="memdesc:gaa8ce944f7edb970a79e3c04f3eac796e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the LIS2MDL sensor.  <br /></td></tr>
<tr class="separator:gaa8ce944f7edb970a79e3c04f3eac796e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga351a80058481cb2efedfcfadfa9f6e88"><td class="memItemLeft" align="right" valign="top">int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___l_i_s2_m_d_l___platform___functions.html#ga351a80058481cb2efedfcfadfa9f6e88">lis2mdl_init_2</a> (<a class="el" href="structstmdev__ctx__t.html">stmdev_ctx_t</a> *ctx)</td></tr>
<tr class="separator:ga351a80058481cb2efedfcfadfa9f6e88"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Functions to connect LIS2MDL driver to STM32H7xx SPI HAL. </p>
<h2 class="groupheader">Function Documentation</h2>
<a id="gaa8ce944f7edb970a79e3c04f3eac796e" name="gaa8ce944f7edb970a79e3c04f3eac796e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaa8ce944f7edb970a79e3c04f3eac796e">&#9670;&#160;</a></span>lis2mdl_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int32_t lis2mdl_init </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structstmdev__ctx__t.html">stmdev_ctx_t</a> *&#160;</td>
          <td class="paramname"><em>ctx</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize the LIS2MDL sensor. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ctx</td><td>Sensor context with SPI handle and platform functions </td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>if OK, -1 if error or WHO_AM_I mismatch </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="lis2mdl__reg_8c_source.html#l01461">1461</a> of file <a class="el" href="lis2mdl__reg_8c_source.html">lis2mdl_reg.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno"> 1462</span>{</div>
<div class="line"><span class="lineno"> 1463</span>  uint8_t who_am_i = 0;</div>
<div class="line"><span class="lineno"> 1464</span>  uint8_t val = 0; <span class="comment">// Temporary variable for get functions</span></div>
<div class="line"><span class="lineno"> 1465</span>  <a class="code hl_struct" href="structlis2mdl__cfg__reg__a__t.html">lis2mdl_cfg_reg_a_t</a> cfg_a;</div>
<div class="line"><span class="lineno"> 1466</span>  <a class="code hl_struct" href="structlis2mdl__cfg__reg__c__t.html">lis2mdl_cfg_reg_c_t</a> cfg_c;</div>
<div class="line"><span class="lineno"> 1467</span> </div>
<div class="line"><span class="lineno"> 1468</span> </div>
<div class="line"><span class="lineno"> 1469</span>  <span class="keywordflow">if</span> (ctx == <a class="code hl_define" href="bmp3__defs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1470</span> </div>
<div class="line"><span class="lineno"> 1471</span> </div>
<div class="line"><span class="lineno"> 1472</span>  ctx-&gt;<a class="code hl_variable" href="structstmdev__ctx__t.html#a99b7a22f79ae58c659c50231257650e5">write_reg</a> = <a class="code hl_function" href="group___l_i_s2_m_d_l___platform___functions.html#ga67b21fa9e2ec45ca3bdae198980f874f">platform_spi_write</a>;</div>
<div class="line"><span class="lineno"> 1473</span>  ctx-&gt;<a class="code hl_variable" href="structstmdev__ctx__t.html#a1e181319243a3922d5a31c246faddbe2">read_reg</a> = <a class="code hl_function" href="group___l_i_s2_m_d_l___platform___functions.html#gaa2c2949e73d04353b41eb92896a7f360">platform_spi_read</a>;</div>
<div class="line"><span class="lineno"> 1474</span>  ctx-&gt;<a class="code hl_variable" href="structstmdev__ctx__t.html#a90a65adf05d7dfc52fb80cb15a09a871">handle</a> = &amp;<a class="code hl_variable" href="group___global___variables.html#gab9da65f935e805137e2eb4e18c5ab224">hspi2</a>; <span class="comment">// Your SPI_HandleTypeDef</span></div>
<div class="line"><span class="lineno"> 1475</span> </div>
<div class="line"><span class="lineno"> 1476</span>  <span class="comment">// Check WHO_AM_I register</span></div>
<div class="line"><span class="lineno"> 1477</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l__common.html#gaec998ff06fe4897604f40b316e4e4f9f">lis2mdl_device_id_get</a>(ctx, &amp;who_am_i) != 0) <span class="keywordflow">return</span> -1; <span class="comment">// Error reading WHO_AM_I</span></div>
<div class="line"><span class="lineno"> 1478</span>  <span class="keywordflow">if</span> (who_am_i != <a class="code hl_define" href="group___l_s_m9_d_s1___infos.html#gac78d76e4aad455cf448a62fd94bb0e07">LIS2MDL_ID</a>){</div>
<div class="line"><span class="lineno"> 1479</span>      <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1480</span>  }  <span class="comment">// WHO_AM_I mismatch (LIS2MDL_ID should be 0x40 as per datasheet)</span></div>
<div class="line"><span class="lineno"> 1481</span> </div>
<div class="line"><span class="lineno"> 1482</span>  <span class="comment">// Perform a software reset</span></div>
<div class="line"><span class="lineno"> 1483</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l__common.html#gadd247cd28425d2dd12a880235070cae2">lis2mdl_reset_set</a>(ctx, 1) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1484</span>  <a class="code hl_define" href="lis2mdl__reg_8c.html#a96075c2f2d062053b08a570c5d0dfae7">platform_delay</a>(5); <span class="comment">// Wait for reset to complete (datasheet doesn&#39;t specify, 5ms is a guess)</span></div>
<div class="line"><span class="lineno"> 1485</span>  <span class="keywordflow">do</span> {</div>
<div class="line"><span class="lineno"> 1486</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l__common.html#gad719c54e368c84db6175d0b1adf797fc">lis2mdl_reset_get</a>(ctx, &amp;val) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1487</span>  } <span class="keywordflow">while</span> (val); <span class="comment">// Poll SOFT_RST bit until it is cleared</span></div>
<div class="line"><span class="lineno"> 1488</span> </div>
<div class="line"><span class="lineno"> 1489</span> </div>
<div class="line"><span class="lineno"> 1490</span>  <span class="comment">// Reboot memory content to reload calibration parameters</span></div>
<div class="line"><span class="lineno"> 1491</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l__common.html#gafe5ce2eaa1b4034119af82c1b313a239">lis2mdl_boot_set</a>(ctx, 1) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1492</span>  <a class="code hl_define" href="lis2mdl__reg_8c.html#a96075c2f2d062053b08a570c5d0dfae7">platform_delay</a>(5); <span class="comment">// Wait for boot to complete</span></div>
<div class="line"><span class="lineno"> 1493</span>   <span class="keywordflow">do</span> {</div>
<div class="line"><span class="lineno"> 1494</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l__common.html#gad3bf7b59d3a7601512d0b981af153516">lis2mdl_boot_get</a>(ctx, &amp;val) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1495</span>  } <span class="keywordflow">while</span> (val); <span class="comment">// Poll REBOOT bit until it is cleared</span></div>
<div class="line"><span class="lineno"> 1496</span> </div>
<div class="line"><span class="lineno"> 1497</span>  <span class="comment">// Configure for 4-wire SPI mode</span></div>
<div class="line"><span class="lineno"> 1498</span>  <span class="comment">// Note: The LIS2MDL CS pin (pin 3) must be tied LOW to enable SPI mode.</span></div>
<div class="line"><span class="lineno"> 1499</span>  <span class="comment">// This function configures the 4WSPI bit in CFG_REG_C for the SDO line.</span></div>
<div class="line"><span class="lineno"> 1500</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l__serial__interface.html#ga7a8ad228f06d2b2432313a1db61c485c">lis2mdl_spi_mode_set</a>(ctx, <a class="code hl_enumvalue" href="group___l_i_s2_m_d_l.html#gga6e8df0b89f46cb0554c7b6dba90b26e8ad6b55351bbd2b51774c6c7f882da178f">LIS2MDL_SPI_4_WIRE</a>) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1501</span> </div>
<div class="line"><span class="lineno"> 1502</span> </div>
<div class="line"><span class="lineno"> 1503</span>  <span class="comment">// Configure CFG_REG_A for:</span></div>
<div class="line"><span class="lineno"> 1504</span>  <span class="comment">// - Temperature compensation enabled</span></div>
<div class="line"><span class="lineno"> 1505</span>  <span class="comment">// - Continuous mode</span></div>
<div class="line"><span class="lineno"> 1506</span>  <span class="comment">// - ODR 10 Hz</span></div>
<div class="line"><span class="lineno"> 1507</span>  <span class="comment">// - High-resolution mode</span></div>
<div class="line"><span class="lineno"> 1508</span>  <span class="comment">// This matches the datasheet startup example (CFG_REG_A = 0x80)</span></div>
<div class="line"><span class="lineno"> 1509</span> </div>
<div class="line"><span class="lineno"> 1510</span>  <span class="comment">// Method 1: Using individual set functions (less efficient due to multiple R-M-W)</span></div>
<div class="line"><span class="lineno"> 1511</span>  <span class="comment">// if (lis2mdl_offset_temp_comp_set(ctx, 1) != 0) return -1;</span></div>
<div class="line"><span class="lineno"> 1512</span>  <span class="comment">// if (lis2mdl_operating_mode_set(ctx, LIS2MDL_CONTINUOUS_MODE) != 0) return -1;</span></div>
<div class="line"><span class="lineno"> 1513</span>  <span class="comment">// if (lis2mdl_data_rate_set(ctx, LIS2MDL_ODR_10HZ) != 0) return -1; // Assuming LIS2MDL_ODR_10HZ is defined</span></div>
<div class="line"><span class="lineno"> 1514</span>  <span class="comment">// if (lis2mdl_power_mode_set(ctx, LIS2MDL_HIGH_RESOLUTION) != 0) return -1;</span></div>
<div class="line"><span class="lineno"> 1515</span> </div>
<div class="line"><span class="lineno"> 1516</span>  <span class="comment">// Method 2: Direct write to CFG_REG_A (more efficient)</span></div>
<div class="line"><span class="lineno"> 1517</span>  cfg_a.<a class="code hl_variable" href="structlis2mdl__cfg__reg__a__t.html#a7a92d69b9e6367fec390e4707d53d831">comp_temp_en</a> = 1;</div>
<div class="line"><span class="lineno"> 1518</span>  cfg_a.<a class="code hl_variable" href="structlis2mdl__cfg__reg__a__t.html#aba94e315c887059b84aaf972dfb74d51">reboot</a> = 0;</div>
<div class="line"><span class="lineno"> 1519</span>  cfg_a.<a class="code hl_variable" href="structlis2mdl__cfg__reg__a__t.html#adf5f9f7cadeaecc1faf7ee0e2fd6e899">soft_rst</a> = 0;</div>
<div class="line"><span class="lineno"> 1520</span>  cfg_a.<a class="code hl_variable" href="structlis2mdl__cfg__reg__a__t.html#a8987e6fa311b36d30743d73db29f2ce5">lp</a> = (uint8_t)<a class="code hl_enumvalue" href="group___l_i_s2_m_d_l.html#ggaa355ceb07602a71cc9b0ea790d09092cafdd5fb2a48608110afb3675878654c2d">LIS2MDL_HIGH_RESOLUTION</a>; <span class="comment">// Assuming LIS2MDL_HIGH_RESOLUTION = 0</span></div>
<div class="line"><span class="lineno"> 1521</span>  cfg_a.<a class="code hl_variable" href="structlis2mdl__cfg__reg__a__t.html#aa563c6c36052844fb8c9aa6da5e933d4">odr</a> = (uint8_t)<a class="code hl_enumvalue" href="group___l_i_s2_m_d_l.html#gga68d219b2df9ae6ceeb8aeedbb343bcccaabfc1602078bf5678dc0cafa598eda60">LIS2MDL_ODR_10Hz</a>;       <span class="comment">// Assuming LIS2MDL_ODR_10Hz = 0</span></div>
<div class="line"><span class="lineno"> 1522</span>  cfg_a.<a class="code hl_variable" href="structlis2mdl__cfg__reg__a__t.html#a009ecdbf198943736769bf9585d5d59f">md</a> = (uint8_t)<a class="code hl_enumvalue" href="group___l_i_s2_m_d_l.html#ggae7d52af78d0e6c5d30e7d956a43ac72eaadcbb97abda958151c5b665fb06e7939">LIS2MDL_CONTINUOUS_MODE</a>; <span class="comment">// Assuming LIS2MDL_CONTINUOUS_MODE = 0</span></div>
<div class="line"><span class="lineno"> 1523</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l___interfaces___functions.html#gab7d0cf44f3a6060e61e22800570e7c35">lis2mdl_write_reg</a>(ctx, <a class="code hl_define" href="group___l_i_s2_m_d_l.html#gaa587192c1d9503e02038954431ecea2f">LIS2MDL_CFG_REG_A</a>, (uint8_t*)&amp;cfg_a, 1) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1524</span> </div>
<div class="line"><span class="lineno"> 1525</span> </div>
<div class="line"><span class="lineno"> 1526</span>  <span class="comment">// Configure CFG_REG_C for:</span></div>
<div class="line"><span class="lineno"> 1527</span>  <span class="comment">// - Block Data Update (BDU) enabled</span></div>
<div class="line"><span class="lineno"> 1528</span>  <span class="comment">// - Data Ready signal on INT/DRDY pin enabled (optional, as per datasheet startup example)</span></div>
<div class="line"><span class="lineno"> 1529</span>  <span class="comment">// - 4-wire SPI is already set by lis2mdl_spi_mode_set above.</span></div>
<div class="line"><span class="lineno"> 1530</span> </div>
<div class="line"><span class="lineno"> 1531</span>  <span class="comment">// Method 1: Using individual set functions</span></div>
<div class="line"><span class="lineno"> 1532</span>  <span class="comment">// if (lis2mdl_block_data_update_set(ctx, 1) != 0) return -1;</span></div>
<div class="line"><span class="lineno"> 1533</span>  <span class="comment">// if (lis2mdl_drdy_on_pin_set(ctx, 1) != 0) return -1; // Optional: enable DRDY on pin</span></div>
<div class="line"><span class="lineno"> 1534</span> </div>
<div class="line"><span class="lineno"> 1535</span>  <span class="comment">// Method 2: Direct write to CFG_REG_C (more efficient, considers 4WSPI already set)</span></div>
<div class="line"><span class="lineno"> 1536</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l___interfaces___functions.html#gad1f6464d952b757691b47aa79d82654e">lis2mdl_read_reg</a>(ctx, <a class="code hl_define" href="group___l_i_s2_m_d_l.html#ga89850b717dba8da58a7e73e5833ba670">LIS2MDL_CFG_REG_C</a>, (uint8_t*)&amp;cfg_c, 1) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1537</span>  cfg_c.<a class="code hl_variable" href="structlis2mdl__cfg__reg__c__t.html#aa2ab8f3c61c7d0e8bb7e2a1917066be5">bdu</a> = 1;</div>
<div class="line"><span class="lineno"> 1538</span>  cfg_c.<a class="code hl_variable" href="structlis2mdl__cfg__reg__c__t.html#a5f5f93dec0f5b3166fbb206a424e444f">drdy_on_pin</a> = 1; <span class="comment">// Enable DRDY on pin as per datasheet example</span></div>
<div class="line"><span class="lineno"> 1539</span>  <span class="comment">// cfg_c._4wspi is already set by lis2mdl_spi_mode_set, no need to change it here</span></div>
<div class="line"><span class="lineno"> 1540</span>  <span class="comment">// unless lis2mdl_spi_mode_set is not called before this.</span></div>
<div class="line"><span class="lineno"> 1541</span>  <span class="comment">// For safety, ensure it&#39;s set if not using the dedicated function earlier:</span></div>
<div class="line"><span class="lineno"> 1542</span>  <span class="comment">// cfg_c._4wspi = 1; // If LIS2MDL_SPI_4_WIRE is desired</span></div>
<div class="line"><span class="lineno"> 1543</span>  cfg_c.<a class="code hl_variable" href="structlis2mdl__cfg__reg__c__t.html#a1a969bee86f0055f1d348617d1664805">i2c_dis</a> = 1; <span class="comment">// Disable I2C if exclusively using SPI</span></div>
<div class="line"><span class="lineno"> 1544</span>  cfg_c.<a class="code hl_variable" href="structlis2mdl__cfg__reg__c__t.html#ae5cb56ee7b780456f45bbe651d831dea">int_on_pin</a> = 0; <span class="comment">// Disable interrupt on pin unless specifically needed</span></div>
<div class="line"><span class="lineno"> 1545</span>  cfg_c.<a class="code hl_variable" href="structlis2mdl__cfg__reg__c__t.html#a8e0d9b5bdc1a82e9e805eb47e4a79e88">self_test</a> = 0; <span class="comment">// Disable self-test</span></div>
<div class="line"><span class="lineno"> 1546</span>  cfg_c.<a class="code hl_variable" href="structlis2mdl__cfg__reg__c__t.html#aeedf4001036bd9e4b8175353a14f160c">ble</a> = (uint8_t)<a class="code hl_enumvalue" href="group___l_i_s2_m_d_l.html#gga8c84a552669bbcab2d871233722ede2ca4943d783a97775711a6da355cf78f3c1">LIS2MDL_LSB_AT_LOW_ADD</a>; <span class="comment">// Default data format</span></div>
<div class="line"><span class="lineno"> 1547</span> </div>
<div class="line"><span class="lineno"> 1548</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l___interfaces___functions.html#gab7d0cf44f3a6060e61e22800570e7c35">lis2mdl_write_reg</a>(ctx, <a class="code hl_define" href="group___l_i_s2_m_d_l.html#ga89850b717dba8da58a7e73e5833ba670">LIS2MDL_CFG_REG_C</a>, (uint8_t*)&amp;cfg_c, 1) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1549</span> </div>
<div class="line"><span class="lineno"> 1550</span> </div>
<div class="line"><span class="lineno"> 1551</span>  <span class="comment">// Sensor is now initialized with basic settings.</span></div>
<div class="line"><span class="lineno"> 1552</span>  <span class="comment">// Further configuration (e.g., interrupts, thresholds) can be done as needed.</span></div>
<div class="line"><span class="lineno"> 1553</span>  <span class="keywordflow">return</span> 0; <span class="comment">// Success</span></div>
<div class="line"><span class="lineno"> 1554</span>}</div>
<div class="ttc" id="abmp3__defs_8h_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="bmp3__defs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdef"><b>Definition</b> <a href="bmp3__defs_8h_source.html#l00088">bmp3_defs.h:88</a></div></div>
<div class="ttc" id="agroup___global___variables_html_gab9da65f935e805137e2eb4e18c5ab224"><div class="ttname"><a href="group___global___variables.html#gab9da65f935e805137e2eb4e18c5ab224">hspi2</a></div><div class="ttdeci">SPI_HandleTypeDef hspi2</div><div class="ttdoc">HAL SPI handle for Sensor Bus 1 (e.g., IMU, Baro).</div><div class="ttdef"><b>Definition</b> <a href="main_8c_source.html#l00062">main.c:62</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l___interfaces___functions_html_gab7d0cf44f3a6060e61e22800570e7c35"><div class="ttname"><a href="group___l_i_s2_m_d_l___interfaces___functions.html#gab7d0cf44f3a6060e61e22800570e7c35">lis2mdl_write_reg</a></div><div class="ttdeci">int32_t __weak lis2mdl_write_reg(const stmdev_ctx_t *ctx, uint8_t reg, uint8_t *data, uint16_t len)</div><div class="ttdoc">Write generic device register.</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8c_source.html#l00092">lis2mdl_reg.c:92</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l___interfaces___functions_html_gad1f6464d952b757691b47aa79d82654e"><div class="ttname"><a href="group___l_i_s2_m_d_l___interfaces___functions.html#gad1f6464d952b757691b47aa79d82654e">lis2mdl_read_reg</a></div><div class="ttdeci">int32_t __weak lis2mdl_read_reg(const stmdev_ctx_t *ctx, uint8_t reg, uint8_t *data, uint16_t len)</div><div class="ttdoc">Read generic device register.</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8c_source.html#l00066">lis2mdl_reg.c:66</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l___platform___functions_html_ga67b21fa9e2ec45ca3bdae198980f874f"><div class="ttname"><a href="group___l_i_s2_m_d_l___platform___functions.html#ga67b21fa9e2ec45ca3bdae198980f874f">platform_spi_write</a></div><div class="ttdeci">static int32_t platform_spi_write(void *handle, uint8_t reg, const uint8_t *bufp, uint16_t len)</div><div class="ttdoc">Write data to LIS2MDL sensor via SPI.</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8c_source.html#l01372">lis2mdl_reg.c:1372</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l___platform___functions_html_gaa2c2949e73d04353b41eb92896a7f360"><div class="ttname"><a href="group___l_i_s2_m_d_l___platform___functions.html#gaa2c2949e73d04353b41eb92896a7f360">platform_spi_read</a></div><div class="ttdeci">static int32_t platform_spi_read(void *handle, uint8_t reg, uint8_t *bufp, uint16_t len)</div><div class="ttdoc">Read data from LIS2MDL sensor via SPI.</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8c_source.html#l01418">lis2mdl_reg.c:1418</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l__common_html_gad3bf7b59d3a7601512d0b981af153516"><div class="ttname"><a href="group___l_i_s2_m_d_l__common.html#gad3bf7b59d3a7601512d0b981af153516">lis2mdl_boot_get</a></div><div class="ttdeci">int32_t lis2mdl_boot_get(const stmdev_ctx_t *ctx, uint8_t *val)</div><div class="ttdoc">Reboot memory content. Reload the calibration parameters.[get].</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8c_source.html#l00843">lis2mdl_reg.c:843</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l__common_html_gad719c54e368c84db6175d0b1adf797fc"><div class="ttname"><a href="group___l_i_s2_m_d_l__common.html#gad719c54e368c84db6175d0b1adf797fc">lis2mdl_reset_get</a></div><div class="ttdeci">int32_t lis2mdl_reset_get(const stmdev_ctx_t *ctx, uint8_t *val)</div><div class="ttdoc">Software reset. Restore the default values in user registers.[get].</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8c_source.html#l00800">lis2mdl_reg.c:800</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l__common_html_gadd247cd28425d2dd12a880235070cae2"><div class="ttname"><a href="group___l_i_s2_m_d_l__common.html#gadd247cd28425d2dd12a880235070cae2">lis2mdl_reset_set</a></div><div class="ttdeci">int32_t lis2mdl_reset_set(const stmdev_ctx_t *ctx, uint8_t val)</div><div class="ttdoc">Software reset. Restore the default values in user registers.[set].</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8c_source.html#l00776">lis2mdl_reg.c:776</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l__common_html_gaec998ff06fe4897604f40b316e4e4f9f"><div class="ttname"><a href="group___l_i_s2_m_d_l__common.html#gaec998ff06fe4897604f40b316e4e4f9f">lis2mdl_device_id_get</a></div><div class="ttdeci">int32_t lis2mdl_device_id_get(const stmdev_ctx_t *ctx, uint8_t *buff)</div><div class="ttdoc">DeviceWhoamI.[get].</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8c_source.html#l00759">lis2mdl_reg.c:759</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l__common_html_gafe5ce2eaa1b4034119af82c1b313a239"><div class="ttname"><a href="group___l_i_s2_m_d_l__common.html#gafe5ce2eaa1b4034119af82c1b313a239">lis2mdl_boot_set</a></div><div class="ttdeci">int32_t lis2mdl_boot_set(const stmdev_ctx_t *ctx, uint8_t val)</div><div class="ttdoc">Reboot memory content. Reload the calibration parameters.[set].</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8c_source.html#l00819">lis2mdl_reg.c:819</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l__serial__interface_html_ga7a8ad228f06d2b2432313a1db61c485c"><div class="ttname"><a href="group___l_i_s2_m_d_l__serial__interface.html#ga7a8ad228f06d2b2432313a1db61c485c">lis2mdl_spi_mode_set</a></div><div class="ttdeci">int32_t lis2mdl_spi_mode_set(const stmdev_ctx_t *ctx, lis2mdl_sim_t val)</div><div class="ttdoc">SPI Serial Interface Mode selection.[set].</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8c_source.html#l01250">lis2mdl_reg.c:1250</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l_html_ga89850b717dba8da58a7e73e5833ba670"><div class="ttname"><a href="group___l_i_s2_m_d_l.html#ga89850b717dba8da58a7e73e5833ba670">LIS2MDL_CFG_REG_C</a></div><div class="ttdeci">#define LIS2MDL_CFG_REG_C</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00227">lis2mdl_reg.h:227</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l_html_gaa587192c1d9503e02038954431ecea2f"><div class="ttname"><a href="group___l_i_s2_m_d_l.html#gaa587192c1d9503e02038954431ecea2f">LIS2MDL_CFG_REG_A</a></div><div class="ttdeci">#define LIS2MDL_CFG_REG_A</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00189">lis2mdl_reg.h:189</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l_html_gga68d219b2df9ae6ceeb8aeedbb343bcccaabfc1602078bf5678dc0cafa598eda60"><div class="ttname"><a href="group___l_i_s2_m_d_l.html#gga68d219b2df9ae6ceeb8aeedbb343bcccaabfc1602078bf5678dc0cafa598eda60">LIS2MDL_ODR_10Hz</a></div><div class="ttdeci">@ LIS2MDL_ODR_10Hz</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00403">lis2mdl_reg.h:403</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l_html_gga6e8df0b89f46cb0554c7b6dba90b26e8ad6b55351bbd2b51774c6c7f882da178f"><div class="ttname"><a href="group___l_i_s2_m_d_l.html#gga6e8df0b89f46cb0554c7b6dba90b26e8ad6b55351bbd2b51774c6c7f882da178f">LIS2MDL_SPI_4_WIRE</a></div><div class="ttdeci">@ LIS2MDL_SPI_4_WIRE</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00513">lis2mdl_reg.h:513</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l_html_gga8c84a552669bbcab2d871233722ede2ca4943d783a97775711a6da355cf78f3c1"><div class="ttname"><a href="group___l_i_s2_m_d_l.html#gga8c84a552669bbcab2d871233722ede2ca4943d783a97775711a6da355cf78f3c1">LIS2MDL_LSB_AT_LOW_ADD</a></div><div class="ttdeci">@ LIS2MDL_LSB_AT_LOW_ADD</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00473">lis2mdl_reg.h:473</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l_html_ggaa355ceb07602a71cc9b0ea790d09092cafdd5fb2a48608110afb3675878654c2d"><div class="ttname"><a href="group___l_i_s2_m_d_l.html#ggaa355ceb07602a71cc9b0ea790d09092cafdd5fb2a48608110afb3675878654c2d">LIS2MDL_HIGH_RESOLUTION</a></div><div class="ttdeci">@ LIS2MDL_HIGH_RESOLUTION</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00413">lis2mdl_reg.h:413</a></div></div>
<div class="ttc" id="agroup___l_i_s2_m_d_l_html_ggae7d52af78d0e6c5d30e7d956a43ac72eaadcbb97abda958151c5b665fb06e7939"><div class="ttname"><a href="group___l_i_s2_m_d_l.html#ggae7d52af78d0e6c5d30e7d956a43ac72eaadcbb97abda958151c5b665fb06e7939">LIS2MDL_CONTINUOUS_MODE</a></div><div class="ttdeci">@ LIS2MDL_CONTINUOUS_MODE</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00392">lis2mdl_reg.h:392</a></div></div>
<div class="ttc" id="agroup___l_s_m9_d_s1___infos_html_gac78d76e4aad455cf448a62fd94bb0e07"><div class="ttname"><a href="group___l_s_m9_d_s1___infos.html#gac78d76e4aad455cf448a62fd94bb0e07">LIS2MDL_ID</a></div><div class="ttdeci">#define LIS2MDL_ID</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00175">lis2mdl_reg.h:175</a></div></div>
<div class="ttc" id="alis2mdl__reg_8c_html_a96075c2f2d062053b08a570c5d0dfae7"><div class="ttname"><a href="lis2mdl__reg_8c.html#a96075c2f2d062053b08a570c5d0dfae7">platform_delay</a></div><div class="ttdeci">#define platform_delay(ms)</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8c_source.html#l00032">lis2mdl_reg.c:32</a></div></div>
<div class="ttc" id="astructlis2mdl__cfg__reg__a__t_html"><div class="ttname"><a href="structlis2mdl__cfg__reg__a__t.html">lis2mdl_cfg_reg_a_t</a></div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00190">lis2mdl_reg.h:191</a></div></div>
<div class="ttc" id="astructlis2mdl__cfg__reg__a__t_html_a009ecdbf198943736769bf9585d5d59f"><div class="ttname"><a href="structlis2mdl__cfg__reg__a__t.html#a009ecdbf198943736769bf9585d5d59f">lis2mdl_cfg_reg_a_t::md</a></div><div class="ttdeci">uint8_t md</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00193">lis2mdl_reg.h:193</a></div></div>
<div class="ttc" id="astructlis2mdl__cfg__reg__a__t_html_a7a92d69b9e6367fec390e4707d53d831"><div class="ttname"><a href="structlis2mdl__cfg__reg__a__t.html#a7a92d69b9e6367fec390e4707d53d831">lis2mdl_cfg_reg_a_t::comp_temp_en</a></div><div class="ttdeci">uint8_t comp_temp_en</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00198">lis2mdl_reg.h:198</a></div></div>
<div class="ttc" id="astructlis2mdl__cfg__reg__a__t_html_a8987e6fa311b36d30743d73db29f2ce5"><div class="ttname"><a href="structlis2mdl__cfg__reg__a__t.html#a8987e6fa311b36d30743d73db29f2ce5">lis2mdl_cfg_reg_a_t::lp</a></div><div class="ttdeci">uint8_t lp</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00195">lis2mdl_reg.h:195</a></div></div>
<div class="ttc" id="astructlis2mdl__cfg__reg__a__t_html_aa563c6c36052844fb8c9aa6da5e933d4"><div class="ttname"><a href="structlis2mdl__cfg__reg__a__t.html#aa563c6c36052844fb8c9aa6da5e933d4">lis2mdl_cfg_reg_a_t::odr</a></div><div class="ttdeci">uint8_t odr</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00194">lis2mdl_reg.h:194</a></div></div>
<div class="ttc" id="astructlis2mdl__cfg__reg__a__t_html_aba94e315c887059b84aaf972dfb74d51"><div class="ttname"><a href="structlis2mdl__cfg__reg__a__t.html#aba94e315c887059b84aaf972dfb74d51">lis2mdl_cfg_reg_a_t::reboot</a></div><div class="ttdeci">uint8_t reboot</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00197">lis2mdl_reg.h:197</a></div></div>
<div class="ttc" id="astructlis2mdl__cfg__reg__a__t_html_adf5f9f7cadeaecc1faf7ee0e2fd6e899"><div class="ttname"><a href="structlis2mdl__cfg__reg__a__t.html#adf5f9f7cadeaecc1faf7ee0e2fd6e899">lis2mdl_cfg_reg_a_t::soft_rst</a></div><div class="ttdeci">uint8_t soft_rst</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00196">lis2mdl_reg.h:196</a></div></div>
<div class="ttc" id="astructlis2mdl__cfg__reg__c__t_html"><div class="ttname"><a href="structlis2mdl__cfg__reg__c__t.html">lis2mdl_cfg_reg_c_t</a></div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00228">lis2mdl_reg.h:229</a></div></div>
<div class="ttc" id="astructlis2mdl__cfg__reg__c__t_html_a1a969bee86f0055f1d348617d1664805"><div class="ttname"><a href="structlis2mdl__cfg__reg__c__t.html#a1a969bee86f0055f1d348617d1664805">lis2mdl_cfg_reg_c_t::i2c_dis</a></div><div class="ttdeci">uint8_t i2c_dis</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00236">lis2mdl_reg.h:236</a></div></div>
<div class="ttc" id="astructlis2mdl__cfg__reg__c__t_html_a5f5f93dec0f5b3166fbb206a424e444f"><div class="ttname"><a href="structlis2mdl__cfg__reg__c__t.html#a5f5f93dec0f5b3166fbb206a424e444f">lis2mdl_cfg_reg_c_t::drdy_on_pin</a></div><div class="ttdeci">uint8_t drdy_on_pin</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00231">lis2mdl_reg.h:231</a></div></div>
<div class="ttc" id="astructlis2mdl__cfg__reg__c__t_html_a8e0d9b5bdc1a82e9e805eb47e4a79e88"><div class="ttname"><a href="structlis2mdl__cfg__reg__c__t.html#a8e0d9b5bdc1a82e9e805eb47e4a79e88">lis2mdl_cfg_reg_c_t::self_test</a></div><div class="ttdeci">uint8_t self_test</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00232">lis2mdl_reg.h:232</a></div></div>
<div class="ttc" id="astructlis2mdl__cfg__reg__c__t_html_aa2ab8f3c61c7d0e8bb7e2a1917066be5"><div class="ttname"><a href="structlis2mdl__cfg__reg__c__t.html#aa2ab8f3c61c7d0e8bb7e2a1917066be5">lis2mdl_cfg_reg_c_t::bdu</a></div><div class="ttdeci">uint8_t bdu</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00235">lis2mdl_reg.h:235</a></div></div>
<div class="ttc" id="astructlis2mdl__cfg__reg__c__t_html_ae5cb56ee7b780456f45bbe651d831dea"><div class="ttname"><a href="structlis2mdl__cfg__reg__c__t.html#ae5cb56ee7b780456f45bbe651d831dea">lis2mdl_cfg_reg_c_t::int_on_pin</a></div><div class="ttdeci">uint8_t int_on_pin</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00237">lis2mdl_reg.h:237</a></div></div>
<div class="ttc" id="astructlis2mdl__cfg__reg__c__t_html_aeedf4001036bd9e4b8175353a14f160c"><div class="ttname"><a href="structlis2mdl__cfg__reg__c__t.html#aeedf4001036bd9e4b8175353a14f160c">lis2mdl_cfg_reg_c_t::ble</a></div><div class="ttdeci">uint8_t ble</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00234">lis2mdl_reg.h:234</a></div></div>
<div class="ttc" id="astructstmdev__ctx__t_html_a1e181319243a3922d5a31c246faddbe2"><div class="ttname"><a href="structstmdev__ctx__t.html#a1e181319243a3922d5a31c246faddbe2">stmdev_ctx_t::read_reg</a></div><div class="ttdeci">stmdev_read_ptr read_reg</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00120">lis2mdl_reg.h:120</a></div></div>
<div class="ttc" id="astructstmdev__ctx__t_html_a90a65adf05d7dfc52fb80cb15a09a871"><div class="ttname"><a href="structstmdev__ctx__t.html#a90a65adf05d7dfc52fb80cb15a09a871">stmdev_ctx_t::handle</a></div><div class="ttdeci">void * handle</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00124">lis2mdl_reg.h:124</a></div></div>
<div class="ttc" id="astructstmdev__ctx__t_html_a99b7a22f79ae58c659c50231257650e5"><div class="ttname"><a href="structstmdev__ctx__t.html#a99b7a22f79ae58c659c50231257650e5">stmdev_ctx_t::write_reg</a></div><div class="ttdeci">stmdev_write_ptr write_reg</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8h_source.html#l00119">lis2mdl_reg.h:119</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="lis2mdl__reg_8h_source.html#l00235">lis2mdl_cfg_reg_c_t::bdu</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00234">lis2mdl_cfg_reg_c_t::ble</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00198">lis2mdl_cfg_reg_a_t::comp_temp_en</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00231">lis2mdl_cfg_reg_c_t::drdy_on_pin</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00124">stmdev_ctx_t::handle</a>, <a class="el" href="main_8c_source.html#l00062">hspi2</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00236">lis2mdl_cfg_reg_c_t::i2c_dis</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00237">lis2mdl_cfg_reg_c_t::int_on_pin</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00843">lis2mdl_boot_get()</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00819">lis2mdl_boot_set()</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00189">LIS2MDL_CFG_REG_A</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00227">LIS2MDL_CFG_REG_C</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00392">LIS2MDL_CONTINUOUS_MODE</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00759">lis2mdl_device_id_get()</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00413">LIS2MDL_HIGH_RESOLUTION</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00175">LIS2MDL_ID</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00473">LIS2MDL_LSB_AT_LOW_ADD</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00403">LIS2MDL_ODR_10Hz</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00066">lis2mdl_read_reg()</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00800">lis2mdl_reset_get()</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00776">lis2mdl_reset_set()</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00513">LIS2MDL_SPI_4_WIRE</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l01250">lis2mdl_spi_mode_set()</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00092">lis2mdl_write_reg()</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00195">lis2mdl_cfg_reg_a_t::lp</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00193">lis2mdl_cfg_reg_a_t::md</a>, <a class="el" href="bmp3__defs_8h_source.html#l00088">NULL</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00194">lis2mdl_cfg_reg_a_t::odr</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00032">platform_delay</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l01418">platform_spi_read()</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l01372">platform_spi_write()</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00120">stmdev_ctx_t::read_reg</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00197">lis2mdl_cfg_reg_a_t::reboot</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00232">lis2mdl_cfg_reg_c_t::self_test</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00196">lis2mdl_cfg_reg_a_t::soft_rst</a>, and <a class="el" href="lis2mdl__reg_8h_source.html#l00119">stmdev_ctx_t::write_reg</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="group___l_i_s2_m_d_l___platform___functions_gaa8ce944f7edb970a79e3c04f3eac796e_cgraph.png" border="0" usemap="#agroup___l_i_s2_m_d_l___platform___functions_gaa8ce944f7edb970a79e3c04f3eac796e_cgraph" alt=""/></div>
<map name="agroup___l_i_s2_m_d_l___platform___functions_gaa8ce944f7edb970a79e3c04f3eac796e_cgraph" id="agroup___l_i_s2_m_d_l___platform___functions_gaa8ce944f7edb970a79e3c04f3eac796e_cgraph">
<area shape="rect" title="Initialize the LIS2MDL sensor." alt="" coords="5,233,92,260"/>
<area shape="rect" href="group___l_i_s2_m_d_l__common.html#gad3bf7b59d3a7601512d0b981af153516" title="Reboot memory content. Reload the calibration parameters.[get]." alt="" coords="155,157,274,184"/>
<area shape="poly" title=" " alt="" coords="70,230,139,194,153,187,155,192,141,198,73,235"/>
<area shape="rect" href="group___l_i_s2_m_d_l___interfaces___functions.html#gad1f6464d952b757691b47aa79d82654e" title="Read generic device register." alt="" coords="340,157,459,184"/>
<area shape="poly" title=" " alt="" coords="55,231,86,185,110,161,138,143,165,134,193,128,250,128,304,137,350,149,349,154,303,142,250,133,194,134,167,139,141,148,113,165,90,189,59,234"/>
<area shape="rect" href="group___l_i_s2_m_d_l__common.html#gafe5ce2eaa1b4034119af82c1b313a239" title="Reboot memory content. Reload the calibration parameters.[set]." alt="" coords="155,208,274,235"/>
<area shape="poly" title=" " alt="" coords="92,238,140,230,140,235,92,243"/>
<area shape="rect" href="group___l_i_s2_m_d_l___interfaces___functions.html#gab7d0cf44f3a6060e61e22800570e7c35" title="Write generic device register." alt="" coords="338,284,460,311"/>
<area shape="poly" title=" " alt="" coords="59,259,90,304,113,328,141,346,180,359,213,361,247,355,289,345,327,333,362,316,364,321,329,338,291,351,248,361,213,366,179,364,139,350,110,332,86,308,55,262"/>
<area shape="rect" href="group___l_i_s2_m_d_l__common.html#gaec998ff06fe4897604f40b316e4e4f9f" title="DeviceWhoamI.[get]." alt="" coords="140,5,290,32"/>
<area shape="poly" title=" " alt="" coords="49,233,58,195,74,144,100,90,117,64,138,42,142,38,146,42,142,46,121,68,104,93,79,146,63,197,55,234"/>
<area shape="rect" href="group___l_i_s2_m_d_l__common.html#gad719c54e368c84db6175d0b1adf797fc" title="Software reset. Restore the default values in user registers.[get]." alt="" coords="153,56,276,83"/>
<area shape="poly" title=" " alt="" coords="53,232,83,169,107,132,138,99,155,88,158,92,141,103,112,136,87,172,57,234"/>
<area shape="rect" href="group___l_i_s2_m_d_l__common.html#gadd247cd28425d2dd12a880235070cae2" title="Software reset. Restore the default values in user registers.[set]." alt="" coords="153,259,276,285"/>
<area shape="poly" title=" " alt="" coords="92,251,138,258,138,263,92,256"/>
<area shape="rect" href="group___l_i_s2_m_d_l__serial__interface.html#ga7a8ad228f06d2b2432313a1db61c485c" title="SPI Serial Interface Mode selection.[set]." alt="" coords="140,309,290,336"/>
<area shape="poly" title=" " alt="" coords="73,258,141,295,155,301,153,306,139,300,70,263"/>
<area shape="rect" href="group___l_i_s2_m_d_l___platform___functions.html#gaa2c2949e73d04353b41eb92896a7f360" title="Read data from LIS2MDL sensor via SPI." alt="" coords="153,411,277,437"/>
<area shape="poly" title=" " alt="" coords="57,259,87,321,112,358,141,390,158,401,155,406,138,394,107,361,83,324,53,262"/>
<area shape="rect" href="group___l_i_s2_m_d_l___platform___functions.html#ga67b21fa9e2ec45ca3bdae198980f874f" title="Write data to LIS2MDL sensor via SPI." alt="" coords="151,461,278,488"/>
<area shape="poly" title=" " alt="" coords="55,260,63,297,79,347,104,401,121,426,142,447,146,451,142,455,138,451,117,429,100,403,74,349,58,298,49,261"/>
<area shape="poly" title=" " alt="" coords="275,168,324,168,324,173,275,173"/>
<area shape="poly" title=" " alt="" coords="266,205,332,186,334,191,267,210"/>
<area shape="poly" title=" " alt="" coords="260,233,291,244,358,274,356,279,289,249,258,238"/>
<area shape="poly" title=" " alt="" coords="270,30,291,42,320,65,345,91,383,142,379,145,341,95,316,69,289,46,267,35"/>
<area shape="poly" title=" " alt="" coords="253,81,291,99,368,146,365,151,289,104,251,86"/>
<area shape="poly" title=" " alt="" coords="262,256,289,244,331,219,368,192,371,196,334,223,291,249,265,260"/>
<area shape="poly" title=" " alt="" coords="278,278,323,284,323,290,277,283"/>
<area shape="poly" title=" " alt="" coords="267,306,289,295,316,273,341,246,379,196,383,199,345,250,320,276,291,300,270,311"/>
<area shape="poly" title=" " alt="" coords="290,310,322,305,323,310,291,315"/>
</map>
</div>

</div>
</div>
<a id="ga351a80058481cb2efedfcfadfa9f6e88" name="ga351a80058481cb2efedfcfadfa9f6e88"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga351a80058481cb2efedfcfadfa9f6e88">&#9670;&#160;</a></span>lis2mdl_init_2()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int32_t lis2mdl_init_2 </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structstmdev__ctx__t.html">stmdev_ctx_t</a> *&#160;</td>
          <td class="paramname"><em>ctx</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="lis2mdl__reg_8c_source.html#l01556">1556</a> of file <a class="el" href="lis2mdl__reg_8c_source.html">lis2mdl_reg.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno"> 1557</span>{</div>
<div class="line"><span class="lineno"> 1558</span>  uint8_t who_am_i = 0;</div>
<div class="line"><span class="lineno"> 1559</span>  uint8_t val = 0; <span class="comment">// Temporary variable for get functions</span></div>
<div class="line"><span class="lineno"> 1560</span>  <a class="code hl_struct" href="structlis2mdl__cfg__reg__a__t.html">lis2mdl_cfg_reg_a_t</a> cfg_a;</div>
<div class="line"><span class="lineno"> 1561</span>  <a class="code hl_struct" href="structlis2mdl__cfg__reg__c__t.html">lis2mdl_cfg_reg_c_t</a> cfg_c;</div>
<div class="line"><span class="lineno"> 1562</span> </div>
<div class="line"><span class="lineno"> 1563</span> </div>
<div class="line"><span class="lineno"> 1564</span>  <span class="keywordflow">if</span> (ctx == <a class="code hl_define" href="bmp3__defs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1565</span> </div>
<div class="line"><span class="lineno"> 1566</span> </div>
<div class="line"><span class="lineno"> 1567</span>  ctx-&gt;<a class="code hl_variable" href="structstmdev__ctx__t.html#a99b7a22f79ae58c659c50231257650e5">write_reg</a> = <a class="code hl_function" href="group___l_i_s2_m_d_l___platform___functions.html#ga67b21fa9e2ec45ca3bdae198980f874f">platform_spi_write</a>;</div>
<div class="line"><span class="lineno"> 1568</span>  ctx-&gt;<a class="code hl_variable" href="structstmdev__ctx__t.html#a1e181319243a3922d5a31c246faddbe2">read_reg</a> = <a class="code hl_function" href="group___l_i_s2_m_d_l___platform___functions.html#gaa2c2949e73d04353b41eb92896a7f360">platform_spi_read</a>;</div>
<div class="line"><span class="lineno"> 1569</span>  ctx-&gt;<a class="code hl_variable" href="structstmdev__ctx__t.html#a90a65adf05d7dfc52fb80cb15a09a871">handle</a> = &amp;<a class="code hl_variable" href="group___global___variables.html#gaec51920045aad7f70cbfd1f58228d866">hspi3</a>; <span class="comment">// Your SPI_HandleTypeDef</span></div>
<div class="line"><span class="lineno"> 1570</span> </div>
<div class="line"><span class="lineno"> 1571</span>  <span class="comment">// Check WHO_AM_I register</span></div>
<div class="line"><span class="lineno"> 1572</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l__common.html#gaec998ff06fe4897604f40b316e4e4f9f">lis2mdl_device_id_get</a>(ctx, &amp;who_am_i) != 0) <span class="keywordflow">return</span> -1; <span class="comment">// Error reading WHO_AM_I</span></div>
<div class="line"><span class="lineno"> 1573</span>  <span class="keywordflow">if</span> (who_am_i != <a class="code hl_define" href="group___l_s_m9_d_s1___infos.html#gac78d76e4aad455cf448a62fd94bb0e07">LIS2MDL_ID</a>) <span class="keywordflow">return</span> -1; <span class="comment">// WHO_AM_I mismatch (LIS2MDL_ID should be 0x40 as per datasheet)</span></div>
<div class="line"><span class="lineno"> 1574</span> </div>
<div class="line"><span class="lineno"> 1575</span>  <span class="comment">// Perform a software reset</span></div>
<div class="line"><span class="lineno"> 1576</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l__common.html#gadd247cd28425d2dd12a880235070cae2">lis2mdl_reset_set</a>(ctx, 1) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1577</span>  <a class="code hl_define" href="lis2mdl__reg_8c.html#a96075c2f2d062053b08a570c5d0dfae7">platform_delay</a>(5); <span class="comment">// Wait for reset to complete (datasheet doesn&#39;t specify, 5ms is a guess)</span></div>
<div class="line"><span class="lineno"> 1578</span>  <span class="keywordflow">do</span> {</div>
<div class="line"><span class="lineno"> 1579</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l__common.html#gad719c54e368c84db6175d0b1adf797fc">lis2mdl_reset_get</a>(ctx, &amp;val) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1580</span>  } <span class="keywordflow">while</span> (val); <span class="comment">// Poll SOFT_RST bit until it is cleared</span></div>
<div class="line"><span class="lineno"> 1581</span> </div>
<div class="line"><span class="lineno"> 1582</span> </div>
<div class="line"><span class="lineno"> 1583</span>  <span class="comment">// Reboot memory content to reload calibration parameters</span></div>
<div class="line"><span class="lineno"> 1584</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l__common.html#gafe5ce2eaa1b4034119af82c1b313a239">lis2mdl_boot_set</a>(ctx, 1) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1585</span>  <a class="code hl_define" href="lis2mdl__reg_8c.html#a96075c2f2d062053b08a570c5d0dfae7">platform_delay</a>(5); <span class="comment">// Wait for boot to complete</span></div>
<div class="line"><span class="lineno"> 1586</span>   <span class="keywordflow">do</span> {</div>
<div class="line"><span class="lineno"> 1587</span>    <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l__common.html#gad3bf7b59d3a7601512d0b981af153516">lis2mdl_boot_get</a>(ctx, &amp;val) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1588</span>  } <span class="keywordflow">while</span> (val); <span class="comment">// Poll REBOOT bit until it is cleared</span></div>
<div class="line"><span class="lineno"> 1589</span> </div>
<div class="line"><span class="lineno"> 1590</span>  <span class="comment">// Configure for 4-wire SPI mode</span></div>
<div class="line"><span class="lineno"> 1591</span>  <span class="comment">// Note: The LIS2MDL CS pin (pin 3) must be tied LOW to enable SPI mode.</span></div>
<div class="line"><span class="lineno"> 1592</span>  <span class="comment">// This function configures the 4WSPI bit in CFG_REG_C for the SDO line.</span></div>
<div class="line"><span class="lineno"> 1593</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l__serial__interface.html#ga7a8ad228f06d2b2432313a1db61c485c">lis2mdl_spi_mode_set</a>(ctx, <a class="code hl_enumvalue" href="group___l_i_s2_m_d_l.html#gga6e8df0b89f46cb0554c7b6dba90b26e8ad6b55351bbd2b51774c6c7f882da178f">LIS2MDL_SPI_4_WIRE</a>) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1594</span> </div>
<div class="line"><span class="lineno"> 1595</span> </div>
<div class="line"><span class="lineno"> 1596</span>  <span class="comment">// Configure CFG_REG_A for:</span></div>
<div class="line"><span class="lineno"> 1597</span>  <span class="comment">// - Temperature compensation enabled</span></div>
<div class="line"><span class="lineno"> 1598</span>  <span class="comment">// - Continuous mode</span></div>
<div class="line"><span class="lineno"> 1599</span>  <span class="comment">// - ODR 10 Hz</span></div>
<div class="line"><span class="lineno"> 1600</span>  <span class="comment">// - High-resolution mode</span></div>
<div class="line"><span class="lineno"> 1601</span>  <span class="comment">// This matches the datasheet startup example (CFG_REG_A = 0x80)</span></div>
<div class="line"><span class="lineno"> 1602</span> </div>
<div class="line"><span class="lineno"> 1603</span>  <span class="comment">// Method 1: Using individual set functions (less efficient due to multiple R-M-W)</span></div>
<div class="line"><span class="lineno"> 1604</span>  <span class="comment">// if (lis2mdl_offset_temp_comp_set(ctx, 1) != 0) return -1;</span></div>
<div class="line"><span class="lineno"> 1605</span>  <span class="comment">// if (lis2mdl_operating_mode_set(ctx, LIS2MDL_CONTINUOUS_MODE) != 0) return -1;</span></div>
<div class="line"><span class="lineno"> 1606</span>  <span class="comment">// if (lis2mdl_data_rate_set(ctx, LIS2MDL_ODR_10HZ) != 0) return -1; // Assuming LIS2MDL_ODR_10HZ is defined</span></div>
<div class="line"><span class="lineno"> 1607</span>  <span class="comment">// if (lis2mdl_power_mode_set(ctx, LIS2MDL_HIGH_RESOLUTION) != 0) return -1;</span></div>
<div class="line"><span class="lineno"> 1608</span> </div>
<div class="line"><span class="lineno"> 1609</span>  <span class="comment">// Method 2: Direct write to CFG_REG_A (more efficient)</span></div>
<div class="line"><span class="lineno"> 1610</span>  cfg_a.<a class="code hl_variable" href="structlis2mdl__cfg__reg__a__t.html#a7a92d69b9e6367fec390e4707d53d831">comp_temp_en</a> = 1;</div>
<div class="line"><span class="lineno"> 1611</span>  cfg_a.<a class="code hl_variable" href="structlis2mdl__cfg__reg__a__t.html#aba94e315c887059b84aaf972dfb74d51">reboot</a> = 0;</div>
<div class="line"><span class="lineno"> 1612</span>  cfg_a.<a class="code hl_variable" href="structlis2mdl__cfg__reg__a__t.html#adf5f9f7cadeaecc1faf7ee0e2fd6e899">soft_rst</a> = 0;</div>
<div class="line"><span class="lineno"> 1613</span>  cfg_a.<a class="code hl_variable" href="structlis2mdl__cfg__reg__a__t.html#a8987e6fa311b36d30743d73db29f2ce5">lp</a> = (uint8_t)<a class="code hl_enumvalue" href="group___l_i_s2_m_d_l.html#ggaa355ceb07602a71cc9b0ea790d09092cafdd5fb2a48608110afb3675878654c2d">LIS2MDL_HIGH_RESOLUTION</a>; <span class="comment">// Assuming LIS2MDL_HIGH_RESOLUTION = 0</span></div>
<div class="line"><span class="lineno"> 1614</span>  cfg_a.<a class="code hl_variable" href="structlis2mdl__cfg__reg__a__t.html#aa563c6c36052844fb8c9aa6da5e933d4">odr</a> = (uint8_t)<a class="code hl_enumvalue" href="group___l_i_s2_m_d_l.html#gga68d219b2df9ae6ceeb8aeedbb343bcccaabfc1602078bf5678dc0cafa598eda60">LIS2MDL_ODR_10Hz</a>;       <span class="comment">// Assuming LIS2MDL_ODR_10Hz = 0</span></div>
<div class="line"><span class="lineno"> 1615</span>  cfg_a.<a class="code hl_variable" href="structlis2mdl__cfg__reg__a__t.html#a009ecdbf198943736769bf9585d5d59f">md</a> = (uint8_t)<a class="code hl_enumvalue" href="group___l_i_s2_m_d_l.html#ggae7d52af78d0e6c5d30e7d956a43ac72eaadcbb97abda958151c5b665fb06e7939">LIS2MDL_CONTINUOUS_MODE</a>; <span class="comment">// Assuming LIS2MDL_CONTINUOUS_MODE = 0</span></div>
<div class="line"><span class="lineno"> 1616</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l___interfaces___functions.html#gab7d0cf44f3a6060e61e22800570e7c35">lis2mdl_write_reg</a>(ctx, <a class="code hl_define" href="group___l_i_s2_m_d_l.html#gaa587192c1d9503e02038954431ecea2f">LIS2MDL_CFG_REG_A</a>, (uint8_t*)&amp;cfg_a, 1) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1617</span> </div>
<div class="line"><span class="lineno"> 1618</span> </div>
<div class="line"><span class="lineno"> 1619</span>  <span class="comment">// Configure CFG_REG_C for:</span></div>
<div class="line"><span class="lineno"> 1620</span>  <span class="comment">// - Block Data Update (BDU) enabled</span></div>
<div class="line"><span class="lineno"> 1621</span>  <span class="comment">// - Data Ready signal on INT/DRDY pin enabled (optional, as per datasheet startup example)</span></div>
<div class="line"><span class="lineno"> 1622</span>  <span class="comment">// - 4-wire SPI is already set by lis2mdl_spi_mode_set above.</span></div>
<div class="line"><span class="lineno"> 1623</span> </div>
<div class="line"><span class="lineno"> 1624</span>  <span class="comment">// Method 1: Using individual set functions</span></div>
<div class="line"><span class="lineno"> 1625</span>  <span class="comment">// if (lis2mdl_block_data_update_set(ctx, 1) != 0) return -1;</span></div>
<div class="line"><span class="lineno"> 1626</span>  <span class="comment">// if (lis2mdl_drdy_on_pin_set(ctx, 1) != 0) return -1; // Optional: enable DRDY on pin</span></div>
<div class="line"><span class="lineno"> 1627</span> </div>
<div class="line"><span class="lineno"> 1628</span>  <span class="comment">// Method 2: Direct write to CFG_REG_C (more efficient, considers 4WSPI already set)</span></div>
<div class="line"><span class="lineno"> 1629</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l___interfaces___functions.html#gad1f6464d952b757691b47aa79d82654e">lis2mdl_read_reg</a>(ctx, <a class="code hl_define" href="group___l_i_s2_m_d_l.html#ga89850b717dba8da58a7e73e5833ba670">LIS2MDL_CFG_REG_C</a>, (uint8_t*)&amp;cfg_c, 1) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1630</span>  cfg_c.<a class="code hl_variable" href="structlis2mdl__cfg__reg__c__t.html#aa2ab8f3c61c7d0e8bb7e2a1917066be5">bdu</a> = 1;</div>
<div class="line"><span class="lineno"> 1631</span>  cfg_c.<a class="code hl_variable" href="structlis2mdl__cfg__reg__c__t.html#a5f5f93dec0f5b3166fbb206a424e444f">drdy_on_pin</a> = 1; <span class="comment">// Enable DRDY on pin as per datasheet example</span></div>
<div class="line"><span class="lineno"> 1632</span>  <span class="comment">// cfg_c._4wspi is already set by lis2mdl_spi_mode_set, no need to change it here</span></div>
<div class="line"><span class="lineno"> 1633</span>  <span class="comment">// unless lis2mdl_spi_mode_set is not called before this.</span></div>
<div class="line"><span class="lineno"> 1634</span>  <span class="comment">// For safety, ensure it&#39;s set if not using the dedicated function earlier:</span></div>
<div class="line"><span class="lineno"> 1635</span>  <span class="comment">// cfg_c._4wspi = 1; // If LIS2MDL_SPI_4_WIRE is desired</span></div>
<div class="line"><span class="lineno"> 1636</span>  cfg_c.<a class="code hl_variable" href="structlis2mdl__cfg__reg__c__t.html#a1a969bee86f0055f1d348617d1664805">i2c_dis</a> = 1; <span class="comment">// Disable I2C if exclusively using SPI</span></div>
<div class="line"><span class="lineno"> 1637</span>  cfg_c.<a class="code hl_variable" href="structlis2mdl__cfg__reg__c__t.html#ae5cb56ee7b780456f45bbe651d831dea">int_on_pin</a> = 0; <span class="comment">// Disable interrupt on pin unless specifically needed</span></div>
<div class="line"><span class="lineno"> 1638</span>  cfg_c.<a class="code hl_variable" href="structlis2mdl__cfg__reg__c__t.html#a8e0d9b5bdc1a82e9e805eb47e4a79e88">self_test</a> = 0; <span class="comment">// Disable self-test</span></div>
<div class="line"><span class="lineno"> 1639</span>  cfg_c.<a class="code hl_variable" href="structlis2mdl__cfg__reg__c__t.html#aeedf4001036bd9e4b8175353a14f160c">ble</a> = (uint8_t)<a class="code hl_enumvalue" href="group___l_i_s2_m_d_l.html#gga8c84a552669bbcab2d871233722ede2ca4943d783a97775711a6da355cf78f3c1">LIS2MDL_LSB_AT_LOW_ADD</a>; <span class="comment">// Default data format</span></div>
<div class="line"><span class="lineno"> 1640</span> </div>
<div class="line"><span class="lineno"> 1641</span>  <span class="keywordflow">if</span> (<a class="code hl_function" href="group___l_i_s2_m_d_l___interfaces___functions.html#gab7d0cf44f3a6060e61e22800570e7c35">lis2mdl_write_reg</a>(ctx, <a class="code hl_define" href="group___l_i_s2_m_d_l.html#ga89850b717dba8da58a7e73e5833ba670">LIS2MDL_CFG_REG_C</a>, (uint8_t*)&amp;cfg_c, 1) != 0) <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="lineno"> 1642</span> </div>
<div class="line"><span class="lineno"> 1643</span> </div>
<div class="line"><span class="lineno"> 1644</span>  <span class="comment">// Sensor is now initialized with basic settings.</span></div>
<div class="line"><span class="lineno"> 1645</span>  <span class="comment">// Further configuration (e.g., interrupts, thresholds) can be done as needed.</span></div>
<div class="line"><span class="lineno"> 1646</span>  <span class="keywordflow">return</span> 0; <span class="comment">// Success</span></div>
<div class="line"><span class="lineno"> 1647</span>}</div>
<div class="ttc" id="agroup___global___variables_html_gaec51920045aad7f70cbfd1f58228d866"><div class="ttname"><a href="group___global___variables.html#gaec51920045aad7f70cbfd1f58228d866">hspi3</a></div><div class="ttdeci">SPI_HandleTypeDef hspi3</div><div class="ttdoc">HAL SPI handle for Sensor Bus 2 (e.g., secondary sensors).</div><div class="ttdef"><b>Definition</b> <a href="main_8c_source.html#l00063">main.c:63</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="lis2mdl__reg_8h_source.html#l00235">lis2mdl_cfg_reg_c_t::bdu</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00234">lis2mdl_cfg_reg_c_t::ble</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00198">lis2mdl_cfg_reg_a_t::comp_temp_en</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00231">lis2mdl_cfg_reg_c_t::drdy_on_pin</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00124">stmdev_ctx_t::handle</a>, <a class="el" href="main_8c_source.html#l00063">hspi3</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00236">lis2mdl_cfg_reg_c_t::i2c_dis</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00237">lis2mdl_cfg_reg_c_t::int_on_pin</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00843">lis2mdl_boot_get()</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00819">lis2mdl_boot_set()</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00189">LIS2MDL_CFG_REG_A</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00227">LIS2MDL_CFG_REG_C</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00392">LIS2MDL_CONTINUOUS_MODE</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00759">lis2mdl_device_id_get()</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00413">LIS2MDL_HIGH_RESOLUTION</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00175">LIS2MDL_ID</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00473">LIS2MDL_LSB_AT_LOW_ADD</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00403">LIS2MDL_ODR_10Hz</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00066">lis2mdl_read_reg()</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00800">lis2mdl_reset_get()</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00776">lis2mdl_reset_set()</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00513">LIS2MDL_SPI_4_WIRE</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l01250">lis2mdl_spi_mode_set()</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00092">lis2mdl_write_reg()</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00195">lis2mdl_cfg_reg_a_t::lp</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00193">lis2mdl_cfg_reg_a_t::md</a>, <a class="el" href="bmp3__defs_8h_source.html#l00088">NULL</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00194">lis2mdl_cfg_reg_a_t::odr</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00032">platform_delay</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l01418">platform_spi_read()</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l01372">platform_spi_write()</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00120">stmdev_ctx_t::read_reg</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00197">lis2mdl_cfg_reg_a_t::reboot</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00232">lis2mdl_cfg_reg_c_t::self_test</a>, <a class="el" href="lis2mdl__reg_8h_source.html#l00196">lis2mdl_cfg_reg_a_t::soft_rst</a>, and <a class="el" href="lis2mdl__reg_8h_source.html#l00119">stmdev_ctx_t::write_reg</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="group___l_i_s2_m_d_l___platform___functions_ga351a80058481cb2efedfcfadfa9f6e88_cgraph.png" border="0" usemap="#agroup___l_i_s2_m_d_l___platform___functions_ga351a80058481cb2efedfcfadfa9f6e88_cgraph" alt=""/></div>
<map name="agroup___l_i_s2_m_d_l___platform___functions_ga351a80058481cb2efedfcfadfa9f6e88_cgraph" id="agroup___l_i_s2_m_d_l___platform___functions_ga351a80058481cb2efedfcfadfa9f6e88_cgraph">
<area shape="rect" title=" " alt="" coords="5,233,106,260"/>
<area shape="rect" href="group___l_i_s2_m_d_l__common.html#gad3bf7b59d3a7601512d0b981af153516" title="Reboot memory content. Reload the calibration parameters.[get]." alt="" coords="169,157,288,184"/>
<area shape="poly" title=" " alt="" coords="80,230,153,194,168,187,170,192,155,198,82,235"/>
<area shape="rect" href="group___l_i_s2_m_d_l___interfaces___functions.html#gad1f6464d952b757691b47aa79d82654e" title="Read generic device register." alt="" coords="354,157,473,184"/>
<area shape="poly" title=" " alt="" coords="63,231,97,185,122,161,153,143,179,134,207,129,263,129,317,137,363,149,361,154,316,142,263,134,207,134,181,139,155,148,126,165,101,189,67,234"/>
<area shape="rect" href="group___l_i_s2_m_d_l__common.html#gafe5ce2eaa1b4034119af82c1b313a239" title="Reboot memory content. Reload the calibration parameters.[set]." alt="" coords="169,208,288,235"/>
<area shape="poly" title=" " alt="" coords="106,237,153,230,154,235,107,242"/>
<area shape="rect" href="group___l_i_s2_m_d_l___interfaces___functions.html#gab7d0cf44f3a6060e61e22800570e7c35" title="Write generic device register." alt="" coords="352,284,474,311"/>
<area shape="poly" title=" " alt="" coords="67,259,101,304,126,328,155,346,194,359,227,361,261,355,303,345,341,333,376,316,378,321,343,338,305,351,262,360,228,366,193,364,153,350,122,332,97,308,63,262"/>
<area shape="rect" href="group___l_i_s2_m_d_l__common.html#gaec998ff06fe4897604f40b316e4e4f9f" title="DeviceWhoamI.[get]." alt="" coords="154,5,304,32"/>
<area shape="poly" title=" " alt="" coords="57,232,66,195,84,144,112,90,131,64,152,42,157,38,160,42,155,46,135,68,117,93,89,146,72,197,62,234"/>
<area shape="rect" href="group___l_i_s2_m_d_l__common.html#gad719c54e368c84db6175d0b1adf797fc" title="Software reset. Restore the default values in user registers.[get]." alt="" coords="167,56,290,83"/>
<area shape="poly" title=" " alt="" coords="60,231,94,169,120,132,152,99,169,88,172,92,155,103,124,136,98,172,65,234"/>
<area shape="rect" href="group___l_i_s2_m_d_l__common.html#gadd247cd28425d2dd12a880235070cae2" title="Software reset. Restore the default values in user registers.[set]." alt="" coords="167,259,290,285"/>
<area shape="poly" title=" " alt="" coords="107,251,152,258,151,263,106,257"/>
<area shape="rect" href="group___l_i_s2_m_d_l__serial__interface.html#ga7a8ad228f06d2b2432313a1db61c485c" title="SPI Serial Interface Mode selection.[set]." alt="" coords="154,309,304,336"/>
<area shape="poly" title=" " alt="" coords="82,258,155,295,170,301,168,306,153,300,80,263"/>
<area shape="rect" href="group___l_i_s2_m_d_l___platform___functions.html#gaa2c2949e73d04353b41eb92896a7f360" title="Read data from LIS2MDL sensor via SPI." alt="" coords="167,411,291,437"/>
<area shape="poly" title=" " alt="" coords="65,259,98,321,124,358,155,390,172,401,169,406,152,394,120,361,94,324,60,262"/>
<area shape="rect" href="group___l_i_s2_m_d_l___platform___functions.html#ga67b21fa9e2ec45ca3bdae198980f874f" title="Write data to LIS2MDL sensor via SPI." alt="" coords="165,461,292,488"/>
<area shape="poly" title=" " alt="" coords="62,260,72,297,89,347,117,401,135,426,155,447,160,451,157,455,152,451,131,429,112,404,84,349,66,298,57,261"/>
<area shape="poly" title=" " alt="" coords="289,168,338,168,338,173,289,173"/>
<area shape="poly" title=" " alt="" coords="280,205,346,186,348,191,281,210"/>
<area shape="poly" title=" " alt="" coords="274,233,305,244,372,274,370,279,303,249,272,238"/>
<area shape="poly" title=" " alt="" coords="284,30,305,42,334,65,359,91,397,142,393,145,355,95,330,69,303,46,281,35"/>
<area shape="poly" title=" " alt="" coords="267,81,305,99,382,146,379,151,303,104,265,86"/>
<area shape="poly" title=" " alt="" coords="276,256,303,244,345,219,382,192,385,196,348,223,305,249,279,260"/>
<area shape="poly" title=" " alt="" coords="292,278,337,284,337,290,291,283"/>
<area shape="poly" title=" " alt="" coords="281,306,303,295,330,273,355,246,393,196,397,199,359,250,334,276,305,300,284,311"/>
<area shape="poly" title=" " alt="" coords="304,310,336,305,337,310,305,315"/>
</map>
</div>

</div>
</div>
<a id="gaa2c2949e73d04353b41eb92896a7f360" name="gaa2c2949e73d04353b41eb92896a7f360"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaa2c2949e73d04353b41eb92896a7f360">&#9670;&#160;</a></span>platform_spi_read()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int32_t platform_spi_read </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>reg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t *&#160;</td>
          <td class="paramname"><em>bufp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Read data from LIS2MDL sensor via SPI. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">handle</td><td>Pointer to SPI_HandleTypeDef (passed via <a class="el" href="structstmdev__ctx__t.html">stmdev_ctx_t</a>) </td></tr>
    <tr><td class="paramname">reg</td><td>Register address to read from </td></tr>
    <tr><td class="paramname">bufp</td><td>Pointer to data buffer to store read data </td></tr>
    <tr><td class="paramname">len</td><td>Number of bytes to read </td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>if OK, -1 if error </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="lis2mdl__reg_8c_source.html#l01418">1418</a> of file <a class="el" href="lis2mdl__reg_8c_source.html">lis2mdl_reg.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno"> 1419</span>{</div>
<div class="line"><span class="lineno"> 1420</span>  SPI_HandleTypeDef *spi_handle = (SPI_HandleTypeDef *)handle;</div>
<div class="line"><span class="lineno"> 1421</span>  uint8_t cmd_byte;</div>
<div class="line"><span class="lineno"> 1422</span> </div>
<div class="line"><span class="lineno"> 1423</span>  <span class="keywordflow">if</span> (spi_handle == <a class="code hl_define" href="bmp3__defs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || bufp == <a class="code hl_define" href="bmp3__defs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><span class="lineno"> 1424</span>    <span class="keywordflow">return</span> -1; <span class="comment">// Invalid arguments</span></div>
<div class="line"><span class="lineno"> 1425</span>  }</div>
<div class="line"><span class="lineno"> 1426</span> </div>
<div class="line"><span class="lineno"> 1427</span>  <span class="comment">// LIS2MDL SPI read command: MSB=1 for read, followed by 7-bit register address</span></div>
<div class="line"><span class="lineno"> 1428</span>  cmd_byte = (reg &amp; 0x7F) | 0x80; <span class="comment">// Set MSB to 1 for read</span></div>
<div class="line"><span class="lineno"> 1429</span> </div>
<div class="line"><span class="lineno"> 1430</span> </div>
<div class="line"><span class="lineno"> 1431</span>  <span class="keywordflow">if</span>(HAL_GPIO_ReadPin(IMU_CS_GPIO_Port,IMU_CS_Pin)!=GPIO_PIN_SET){IMU_CS_HIGH;}</div>
<div class="line"><span class="lineno"> 1432</span>  <span class="keywordflow">if</span>(HAL_GPIO_ReadPin(BARO_CS_GPIO_Port,BARO_CS_Pin)!=GPIO_PIN_SET){BMP390_CS_HIGH;}</div>
<div class="line"><span class="lineno"> 1433</span>  <span class="comment">// Pull CS pin low to select the device</span></div>
<div class="line"><span class="lineno"> 1434</span>  HAL_GPIO_WritePin(<a class="code hl_define" href="lis2mdl__reg_8c.html#abfa2a48b9c2313537dbf53e0c54ad13f">LIS2MDL_CS_GPIO_Port</a>, <a class="code hl_define" href="lis2mdl__reg_8c.html#ac64e87a2aab1c7c036d36ada02fb84a6">LIS2MDL_CS_Pin</a>, GPIO_PIN_RESET);</div>
<div class="line"><span class="lineno"> 1435</span> </div>
<div class="line"><span class="lineno"> 1436</span>  <span class="comment">// Transmit the command byte (register address with read flag)</span></div>
<div class="line"><span class="lineno"> 1437</span>  <span class="keywordflow">if</span> (HAL_SPI_Transmit(spi_handle, &amp;cmd_byte, 1, <a class="code hl_define" href="lis2mdl__reg_8c.html#ae96de9a9c408481b381bb54f506fab5c">LIS2MDL_SPI_TIMEOUT</a>) != <a class="code hl_enumvalue" href="z__qflash___w25_q_x_x_x_8h.html#a63c0679d1cb8b8c684fbb0632743478fa6eb724a07061d89a4a2052744e5a3632">HAL_OK</a>)</div>
<div class="line"><span class="lineno"> 1438</span>  {</div>
<div class="line"><span class="lineno"> 1439</span>    HAL_GPIO_WritePin(<a class="code hl_define" href="lis2mdl__reg_8c.html#abfa2a48b9c2313537dbf53e0c54ad13f">LIS2MDL_CS_GPIO_Port</a>, <a class="code hl_define" href="lis2mdl__reg_8c.html#ac64e87a2aab1c7c036d36ada02fb84a6">LIS2MDL_CS_Pin</a>, GPIO_PIN_SET); <span class="comment">// Release CS</span></div>
<div class="line"><span class="lineno"> 1440</span>    <span class="keywordflow">return</span> -1; <span class="comment">// SPI transmission error</span></div>
<div class="line"><span class="lineno"> 1441</span>  }</div>
<div class="line"><span class="lineno"> 1442</span> </div>
<div class="line"><span class="lineno"> 1443</span>  <span class="comment">// Receive the data</span></div>
<div class="line"><span class="lineno"> 1444</span>  <span class="keywordflow">if</span> (HAL_SPI_Receive(spi_handle, bufp, len, <a class="code hl_define" href="lis2mdl__reg_8c.html#ae96de9a9c408481b381bb54f506fab5c">LIS2MDL_SPI_TIMEOUT</a>) != <a class="code hl_enumvalue" href="z__qflash___w25_q_x_x_x_8h.html#a63c0679d1cb8b8c684fbb0632743478fa6eb724a07061d89a4a2052744e5a3632">HAL_OK</a>)</div>
<div class="line"><span class="lineno"> 1445</span>  {</div>
<div class="line"><span class="lineno"> 1446</span>    HAL_GPIO_WritePin(<a class="code hl_define" href="lis2mdl__reg_8c.html#abfa2a48b9c2313537dbf53e0c54ad13f">LIS2MDL_CS_GPIO_Port</a>, <a class="code hl_define" href="lis2mdl__reg_8c.html#ac64e87a2aab1c7c036d36ada02fb84a6">LIS2MDL_CS_Pin</a>, GPIO_PIN_SET); <span class="comment">// Release CS</span></div>
<div class="line"><span class="lineno"> 1447</span>    <span class="keywordflow">return</span> -1; <span class="comment">// SPI reception error</span></div>
<div class="line"><span class="lineno"> 1448</span>  }</div>
<div class="line"><span class="lineno"> 1449</span> </div>
<div class="line"><span class="lineno"> 1450</span>  <span class="comment">// Pull CS pin high to deselect the device</span></div>
<div class="line"><span class="lineno"> 1451</span>  HAL_GPIO_WritePin(<a class="code hl_define" href="lis2mdl__reg_8c.html#abfa2a48b9c2313537dbf53e0c54ad13f">LIS2MDL_CS_GPIO_Port</a>, <a class="code hl_define" href="lis2mdl__reg_8c.html#ac64e87a2aab1c7c036d36ada02fb84a6">LIS2MDL_CS_Pin</a>, GPIO_PIN_SET);</div>
<div class="line"><span class="lineno"> 1452</span> </div>
<div class="line"><span class="lineno"> 1453</span>  <span class="keywordflow">return</span> 0; <span class="comment">// Success</span></div>
<div class="line"><span class="lineno"> 1454</span>}</div>
<div class="ttc" id="alis2mdl__reg_8c_html_abfa2a48b9c2313537dbf53e0c54ad13f"><div class="ttname"><a href="lis2mdl__reg_8c.html#abfa2a48b9c2313537dbf53e0c54ad13f">LIS2MDL_CS_GPIO_Port</a></div><div class="ttdeci">#define LIS2MDL_CS_GPIO_Port</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8c_source.html#l00024">lis2mdl_reg.c:24</a></div></div>
<div class="ttc" id="alis2mdl__reg_8c_html_ac64e87a2aab1c7c036d36ada02fb84a6"><div class="ttname"><a href="lis2mdl__reg_8c.html#ac64e87a2aab1c7c036d36ada02fb84a6">LIS2MDL_CS_Pin</a></div><div class="ttdeci">#define LIS2MDL_CS_Pin</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8c_source.html#l00027">lis2mdl_reg.c:27</a></div></div>
<div class="ttc" id="alis2mdl__reg_8c_html_ae96de9a9c408481b381bb54f506fab5c"><div class="ttname"><a href="lis2mdl__reg_8c.html#ae96de9a9c408481b381bb54f506fab5c">LIS2MDL_SPI_TIMEOUT</a></div><div class="ttdeci">#define LIS2MDL_SPI_TIMEOUT</div><div class="ttdef"><b>Definition</b> <a href="lis2mdl__reg_8c_source.html#l00036">lis2mdl_reg.c:36</a></div></div>
<div class="ttc" id="az__qflash___w25_q_x_x_x_8h_html_a63c0679d1cb8b8c684fbb0632743478fa6eb724a07061d89a4a2052744e5a3632"><div class="ttname"><a href="z__qflash___w25_q_x_x_x_8h.html#a63c0679d1cb8b8c684fbb0632743478fa6eb724a07061d89a4a2052744e5a3632">HAL_OK</a></div><div class="ttdeci">@ HAL_OK</div><div class="ttdef"><b>Definition</b> <a href="z__qflash___w25_q_x_x_x_8h_source.html#l00316">z_qflash_W25QXXX.h:316</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="z__qflash___w25_q_x_x_x_8h_source.html#l00316">HAL_OK</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00024">LIS2MDL_CS_GPIO_Port</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00027">LIS2MDL_CS_Pin</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00036">LIS2MDL_SPI_TIMEOUT</a>, and <a class="el" href="bmp3__defs_8h_source.html#l00088">NULL</a>.</p>

<p class="reference">Referenced by <a class="el" href="lis2mdl__reg_8c_source.html#l01461">lis2mdl_init()</a>, and <a class="el" href="lis2mdl__reg_8c_source.html#l01556">lis2mdl_init_2()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="group___l_i_s2_m_d_l___platform___functions_gaa2c2949e73d04353b41eb92896a7f360_icgraph.png" border="0" usemap="#agroup___l_i_s2_m_d_l___platform___functions_gaa2c2949e73d04353b41eb92896a7f360_icgraph" alt=""/></div>
<map name="agroup___l_i_s2_m_d_l___platform___functions_gaa2c2949e73d04353b41eb92896a7f360_icgraph" id="agroup___l_i_s2_m_d_l___platform___functions_gaa2c2949e73d04353b41eb92896a7f360_icgraph">
<area shape="rect" title="Read data from LIS2MDL sensor via SPI." alt="" coords="154,31,278,57"/>
<area shape="rect" href="group___l_i_s2_m_d_l___platform___functions.html#gaa8ce944f7edb970a79e3c04f3eac796e" title="Initialize the LIS2MDL sensor." alt="" coords="12,5,99,32"/>
<area shape="poly" title=" " alt="" coords="138,34,99,28,100,23,139,29"/>
<area shape="rect" href="group___l_i_s2_m_d_l___platform___functions.html#ga351a80058481cb2efedfcfadfa9f6e88" title=" " alt="" coords="5,56,106,83"/>
<area shape="poly" title=" " alt="" coords="139,59,107,64,106,59,138,54"/>
</map>
</div>

</div>
</div>
<a id="ga67b21fa9e2ec45ca3bdae198980f874f" name="ga67b21fa9e2ec45ca3bdae198980f874f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga67b21fa9e2ec45ca3bdae198980f874f">&#9670;&#160;</a></span>platform_spi_write()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int32_t platform_spi_write </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>reg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint8_t *&#160;</td>
          <td class="paramname"><em>bufp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t&#160;</td>
          <td class="paramname"><em>len</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Write data to LIS2MDL sensor via SPI. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">handle</td><td>Pointer to SPI_HandleTypeDef (passed via <a class="el" href="structstmdev__ctx__t.html">stmdev_ctx_t</a>) </td></tr>
    <tr><td class="paramname">reg</td><td>Register address to write to </td></tr>
    <tr><td class="paramname">bufp</td><td>Pointer to data buffer to write </td></tr>
    <tr><td class="paramname">len</td><td>Number of bytes to write </td></tr>
  </table>
  </dd>
</dl>
<dl class="retval"><dt>Return values</dt><dd>
  <table class="retval">
    <tr><td class="paramname">0</td><td>if OK, -1 if error </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="lis2mdl__reg_8c_source.html#l01372">1372</a> of file <a class="el" href="lis2mdl__reg_8c_source.html">lis2mdl_reg.c</a>.</p>
<div class="fragment"><div class="line"><span class="lineno"> 1373</span>{</div>
<div class="line"><span class="lineno"> 1374</span>  SPI_HandleTypeDef *spi_handle = (SPI_HandleTypeDef *)handle;</div>
<div class="line"><span class="lineno"> 1375</span>  uint8_t cmd_byte;</div>
<div class="line"><span class="lineno"> 1376</span> </div>
<div class="line"><span class="lineno"> 1377</span>  <span class="keywordflow">if</span> (spi_handle == <a class="code hl_define" href="bmp3__defs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || bufp == <a class="code hl_define" href="bmp3__defs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {</div>
<div class="line"><span class="lineno"> 1378</span>    <span class="keywordflow">return</span> -1; <span class="comment">// Invalid arguments</span></div>
<div class="line"><span class="lineno"> 1379</span>  }</div>
<div class="line"><span class="lineno"> 1380</span> </div>
<div class="line"><span class="lineno"> 1381</span>  <span class="comment">// LIS2MDL SPI write command: MSB=0 for write, followed by 7-bit register address</span></div>
<div class="line"><span class="lineno"> 1382</span>  cmd_byte = reg &amp; 0x7F; <span class="comment">// Ensure MSB is 0 for write</span></div>
<div class="line"><span class="lineno"> 1383</span> </div>
<div class="line"><span class="lineno"> 1384</span>  BMP390_CS_HIGH;</div>
<div class="line"><span class="lineno"> 1385</span>  IMU_CS_HIGH;</div>
<div class="line"><span class="lineno"> 1386</span>  <span class="comment">// Pull CS pin low to select the device</span></div>
<div class="line"><span class="lineno"> 1387</span>  HAL_GPIO_WritePin(<a class="code hl_define" href="lis2mdl__reg_8c.html#abfa2a48b9c2313537dbf53e0c54ad13f">LIS2MDL_CS_GPIO_Port</a>, <a class="code hl_define" href="lis2mdl__reg_8c.html#ac64e87a2aab1c7c036d36ada02fb84a6">LIS2MDL_CS_Pin</a>, GPIO_PIN_RESET);</div>
<div class="line"><span class="lineno"> 1388</span> </div>
<div class="line"><span class="lineno"> 1389</span> </div>
<div class="line"><span class="lineno"> 1390</span>  <span class="comment">// Transmit the command byte (register address with write flag)</span></div>
<div class="line"><span class="lineno"> 1391</span>  <span class="keywordflow">if</span> (HAL_SPI_Transmit(spi_handle, &amp;cmd_byte, 1, <a class="code hl_define" href="lis2mdl__reg_8c.html#ae96de9a9c408481b381bb54f506fab5c">LIS2MDL_SPI_TIMEOUT</a>) != <a class="code hl_enumvalue" href="z__qflash___w25_q_x_x_x_8h.html#a63c0679d1cb8b8c684fbb0632743478fa6eb724a07061d89a4a2052744e5a3632">HAL_OK</a>)</div>
<div class="line"><span class="lineno"> 1392</span>  {</div>
<div class="line"><span class="lineno"> 1393</span>    HAL_GPIO_WritePin(<a class="code hl_define" href="lis2mdl__reg_8c.html#abfa2a48b9c2313537dbf53e0c54ad13f">LIS2MDL_CS_GPIO_Port</a>, <a class="code hl_define" href="lis2mdl__reg_8c.html#ac64e87a2aab1c7c036d36ada02fb84a6">LIS2MDL_CS_Pin</a>, GPIO_PIN_SET); <span class="comment">// Release CS</span></div>
<div class="line"><span class="lineno"> 1394</span>    <span class="keywordflow">return</span> -1; <span class="comment">// SPI transmission error</span></div>
<div class="line"><span class="lineno"> 1395</span>  }</div>
<div class="line"><span class="lineno"> 1396</span> </div>
<div class="line"><span class="lineno"> 1397</span>  <span class="comment">// Transmit the data</span></div>
<div class="line"><span class="lineno"> 1398</span>  <span class="keywordflow">if</span> (HAL_SPI_Transmit(spi_handle, (uint8_t*)bufp, len, <a class="code hl_define" href="lis2mdl__reg_8c.html#ae96de9a9c408481b381bb54f506fab5c">LIS2MDL_SPI_TIMEOUT</a>) != <a class="code hl_enumvalue" href="z__qflash___w25_q_x_x_x_8h.html#a63c0679d1cb8b8c684fbb0632743478fa6eb724a07061d89a4a2052744e5a3632">HAL_OK</a>)</div>
<div class="line"><span class="lineno"> 1399</span>  {</div>
<div class="line"><span class="lineno"> 1400</span>    HAL_GPIO_WritePin(<a class="code hl_define" href="lis2mdl__reg_8c.html#abfa2a48b9c2313537dbf53e0c54ad13f">LIS2MDL_CS_GPIO_Port</a>, <a class="code hl_define" href="lis2mdl__reg_8c.html#ac64e87a2aab1c7c036d36ada02fb84a6">LIS2MDL_CS_Pin</a>, GPIO_PIN_SET); <span class="comment">// Release CS</span></div>
<div class="line"><span class="lineno"> 1401</span>    <span class="keywordflow">return</span> -1; <span class="comment">// SPI transmission error</span></div>
<div class="line"><span class="lineno"> 1402</span>  }</div>
<div class="line"><span class="lineno"> 1403</span> </div>
<div class="line"><span class="lineno"> 1404</span>  <span class="comment">// Pull CS pin high to deselect the device</span></div>
<div class="line"><span class="lineno"> 1405</span>  HAL_GPIO_WritePin(<a class="code hl_define" href="lis2mdl__reg_8c.html#abfa2a48b9c2313537dbf53e0c54ad13f">LIS2MDL_CS_GPIO_Port</a>, <a class="code hl_define" href="lis2mdl__reg_8c.html#ac64e87a2aab1c7c036d36ada02fb84a6">LIS2MDL_CS_Pin</a>, GPIO_PIN_SET);</div>
<div class="line"><span class="lineno"> 1406</span> </div>
<div class="line"><span class="lineno"> 1407</span>  <span class="keywordflow">return</span> 0; <span class="comment">// Success</span></div>
<div class="line"><span class="lineno"> 1408</span>}</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="z__qflash___w25_q_x_x_x_8h_source.html#l00316">HAL_OK</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00024">LIS2MDL_CS_GPIO_Port</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00027">LIS2MDL_CS_Pin</a>, <a class="el" href="lis2mdl__reg_8c_source.html#l00036">LIS2MDL_SPI_TIMEOUT</a>, and <a class="el" href="bmp3__defs_8h_source.html#l00088">NULL</a>.</p>

<p class="reference">Referenced by <a class="el" href="lis2mdl__reg_8c_source.html#l01461">lis2mdl_init()</a>, and <a class="el" href="lis2mdl__reg_8c_source.html#l01556">lis2mdl_init_2()</a>.</p>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="group___l_i_s2_m_d_l___platform___functions_ga67b21fa9e2ec45ca3bdae198980f874f_icgraph.png" border="0" usemap="#agroup___l_i_s2_m_d_l___platform___functions_ga67b21fa9e2ec45ca3bdae198980f874f_icgraph" alt=""/></div>
<map name="agroup___l_i_s2_m_d_l___platform___functions_ga67b21fa9e2ec45ca3bdae198980f874f_icgraph" id="agroup___l_i_s2_m_d_l___platform___functions_ga67b21fa9e2ec45ca3bdae198980f874f_icgraph">
<area shape="rect" title="Write data to LIS2MDL sensor via SPI." alt="" coords="154,31,281,57"/>
<area shape="rect" href="group___l_i_s2_m_d_l___platform___functions.html#gaa8ce944f7edb970a79e3c04f3eac796e" title="Initialize the LIS2MDL sensor." alt="" coords="12,5,99,32"/>
<area shape="poly" title=" " alt="" coords="138,34,99,28,100,23,138,29"/>
<area shape="rect" href="group___l_i_s2_m_d_l___platform___functions.html#ga351a80058481cb2efedfcfadfa9f6e88" title=" " alt="" coords="5,56,106,83"/>
<area shape="poly" title=" " alt="" coords="139,59,106,64,106,59,138,54"/>
</map>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.7 </li>
  </ul>
</div>
</body>
</html>
